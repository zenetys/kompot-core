#!/bin/bash
PROGNAME=${0##*/}
fatal() { echo "FATAL: $PROGNAME: $*" >&2; exit 2; }
info() { echo "INFO: $PROGNAME: $*" >&2; }

source /etc/profile.d/kompot-path.sh ||
    fatal 'Failed to source /etc/profile.d/kompot-path.sh'

if [[ -f /var/lib/grafana/grafana.db ]]; then
    ndashboard=$(sqlite3 /var/lib/grafana/grafana.db 'select count(*) from dashboard')
    if [[ $ndashboard -gt 0 && $FORCE != 1 ]]; then
        fatal 'Database not empty, need force to continue'
    fi
fi

if [[ $RESET == 1 ]]; then
    zservice stop grafana-server
    rpm -e --nodeps grafana
    find /var/lib/grafana/ -mindepth 1 -maxdepth 1 -exec rm -rfv {} +
    rm -rfv /etc/grafana
    dnf install -y grafana
fi

zservice start grafana-server
ts=$(date +%s)
wait=0
last_size=
last_migration=
size_stable=0
migration_stable=0

while (( wait++ < 90 )); do
    info "Wait database ready, try=$wait, size_stable=$size_stable, migration_stable=$migration_stable"
    sleep 1
    [[ -f /var/lib/grafana/grafana.db ]] || continue
    cur_size=$(stat -c %s /var/lib/grafana/grafana.db 2>/dev/null)
    cur_migration=$(sqlite3 /var/lib/grafana/grafana.db 'select max(id) from migration_log' 2>/dev/null)
    if [[ $cur_migration == $last_migration ]]; then
        (( migration_stable++ ))
    else
        last_migration=$cur_migration
        migration_stable=0
    fi
    if [[ $cur_size == $last_size ]]; then
        (( size_stable++ ))
    else
        last_size=$cur_size
        size_stable=0
    fi
    (( migration_stable > 8 && size_stable > 8 )) && { wait=0; break; }
done
(( wait == 0 )) || fatal 'Database not ready, timeout'

info 'Stop grafana'
zservice stop grafana-server

cp -a /var/lib/grafana/grafana.db{,".$ts"}
for sql in ${0%/*}/*-grafana-*.sql; do
    info "Apply ${sql##*/}"
    if ! sqlite3 /var/lib/grafana/grafana.db < "$sql"; then
        cp -a /var/lib/grafana/grafana.db{".$ts",}
        fatal "Update failed, abort"
    fi
done

info 'Update configuration'
cp -a /etc/grafana/grafana.ini{,".$ts"}
install -m 640 -g grafana /opt/kompot/share/configs/grafana/grafana.ini /etc/grafana/grafana.ini

info 'Start grafana'
zservice start grafana-server
